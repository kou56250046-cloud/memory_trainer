<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🧠 記憶力トレーニング（スコア＆グラフ完全版）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;}
  body{background:var(--bg);color:var(--text);font-family:system-ui;margin:0}
  .wrap{max-width:960px;margin:auto;padding:16px}
  .card{background:var(--panel);padding:16px;border-radius:10px;margin-bottom:16px}
  button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
  .primary{background:var(--accent);color:#000;font-weight:bold}
  .ghost{background:#1f2937;color:var(--text)}
  .danger{background:#ef4444;color:#fff}
  .warn{background:#f59e0b;color:#000}
  .words{font-size:22px;line-height:1.8;margin-top:8px}
  .chip{background:#1f2937;padding:4px 8px;border-radius:12px;margin:2px;display:inline-block}
  .progress{background:#1f2937;height:10px;border-radius:5px;overflow:hidden;margin-top:8px}
  .bar{background:var(--accent);height:100%;width:0%}
  canvas{background:#0b1220;border:1px solid #223;border-radius:8px;width:100%;height:200px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>🧠 記憶力トレーニング</h1>
    <div>
      <button id="start" class="primary">トレーニング開始 ▶</button>
      <button id="resetAll" class="ghost">初期化</button>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <p id="countdownNote"></p>

    <div id="phaseIntro">
      <p>右の設定でラウンド数・秒数・単語数を調整できます。</p>
    </div>

    <div id="phaseShow" hidden>
      <h3>覚えてください</h3>
      <div class="words" id="words"></div>
      <div id="chips"></div>
      <button class="warn" id="autoHide">⏳ 自動で隠す</button>
      <button class="ghost" id="hideNow">🙈 今すぐ隠す</button>
    </div>

    <div id="phaseAnswer" hidden>
      <h3>思い出して入力</h3>
      <textarea id="answer" rows="4" style="width:100%"></textarea>
      <button class="primary" id="scoreBtn">採点 ▶</button>
    </div>

    <div id="phaseResult" hidden>
      <h3>結果</h3>
      <p>正答率: <span id="kpiAcc"></span>% / スコア: <span id="kpiScore"></span></p>
      <p>一致: <span id="outHit"></span></p>
      <p>見落とし: <span id="outMiss"></span></p>
      <p>余分: <span id="outExtra"></span></p>
      <button class="primary" id="nextRound">次へ ▶</button>
    </div>
  </div>

  <!-- サイド設定 -->
  <div class="card">
    <h2>設定</h2>
    <div>ラウンド数：<input id="rounds" type="number" value="3"></div>
    <div>表示秒数：<input id="seconds" type="number" value="10"></div>
    <div>単語数　：<input id="nwords" type="number" value="5"></div>
    <div>単語リスト：<input id="file" type="file"></div>
  </div>

  <div class="card">
    <h2>📊 スコア推移</h2>
    <canvas id="chart"></canvas>
    <div>
      <button id="dailyBtn" class="ghost">日</button>
      <button id="monthlyBtn" class="ghost">月</button>
    </div>
    <canvas id="avgChart"></canvas>
  </div>

  <div class="card">
    <h2>🏅 称号</h2>
    <div id="titleDisplay"></div>
    <div>連続日数：<span id="streakDisplay">0</span></div>
    <div>平均スコア：<span id="avgDisplay">0</span></div>
  </div>

  <div class="card">
    <h2>履歴</h2>
    <table id="histTable">
      <thead><tr><th>#</th><th>日時</th><th>スコア</th><th>正答率</th><th>一致</th><th>見落</th><th>余分</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="exportCsv" class="ghost">CSVエクスポート</button>
    <button id="clearHist" class="danger">履歴クリア</button>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const state = {
  pool:"山 川 海 空 星 月 花 鳥 風 森 石 火 水 木 土 光 夢 心 愛 音".split(" "),
  round:0,total:3,seconds:10,nWords:5,
  history: JSON.parse(localStorage.getItem("hist")||"[]"),
  timer:null,secLeft:0
};

function setPhase(p){
  ["Intro","Show","Answer","Result"].forEach(x=>$("#phase"+x).hidden = p!==x.toLowerCase());
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function sample(a,n){const arr=[...a];shuffle(arr);return arr.slice(0,n);}
function tokens(s){return s.replace(/[、,]/g," ").split(/\s+/).map(x=>x.trim()).filter(Boolean);}


function nextRound(){
  state.round++;
  if(state.round>state.total){alert("終了！");setPhase("intro");return;}
  state.current = sample(state.pool,state.nWords);
  $("#words").textContent = state.current.join("、");
  $("#chips").innerHTML = state.current.map(w=>`<span class="chip">${w}</span>`).join("");
  setPhase("show");
}

function clearTimer(){if(state.timer){clearInterval(state.timer);state.timer=null}}
function hideNow(){clearTimer();setPhase("answer")}
function startAutoHide(){
  clearTimer();
  state.secLeft = state.seconds;
  const bar=$("#bar");
  bar.style.width="100%";
  state.timer = setInterval(()=>{
    state.secLeft--;
    const pct=(state.secLeft/state.seconds)*100;
    bar.style.width=pct+"%";
    $("#countdownNote").textContent=`あと ${state.secLeft} 秒`;
    if(state.secLeft<=0){clearTimer();hideNow();}
  },1000);
}

function calcScore(acc,words,sec){
  return Math.round(acc * (words/sec));
}

function scoreRound(){
  const rec=tokens($("#answer").value);
  const S=new Set(state.current),R=new Set(rec);
  const hit=[...S].filter(x=>R.has(x));
  const miss=[...S].filter(x=>!R.has(x));
  const extra=[...R].filter(x=>!S.has(x));
  const acc = state.current.length ? Math.round(hit.length/state.current.length*100) : 0;
  const score = calcScore(acc,state.current.length,state.seconds);
  $("#kpiAcc").textContent = acc;
  $("#kpiScore").textContent = score;
  $("#outHit").textContent = hit.join("、") || "なし";
  $("#outMiss").textContent = miss.join("、") || "なし";
  $("#outExtra").textContent = extra.join("、") || "なし";

  const row={timestamp:new Date().toLocaleString(),score,accuracy:acc,
             n_hit:hit.length,n_miss:miss.length,n_extra:extra.length};
  state.history.push(row);
  localStorage.setItem("hist",JSON.stringify(state.history));
  refreshTable();
  drawScoreChart();
  drawAvgChart();
  updateTitles();
  setPhase("result");
}

function refreshTable(){
  const tb=$("#histTable tbody");
  tb.innerHTML="";
  state.history.forEach((h,i)=>{
    tb.innerHTML+=`<tr><td>${i+1}</td><td>${h.timestamp}</td><td>${h.score}</td>
                   <td>${h.accuracy}</td><td>${h.n_hit}</td><td>${h.n_miss}</td><td>${h.n_extra}</td></tr>`;
  });
}

// 📊 グラフ
let scoreChart=null,avgChart=null,avgMode="day";
function aggregateScoreByPeriod(){
  const daily={},monthly={};
  for(const h of state.history){
    const d=new Date(h.timestamp);
    const day=d.toLocaleDateString();
    const month=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    (daily[day] ||= []).push(h.score);
    (monthly[month] ||= []).push(h.score);
  }
  const dailyAvg=Object.entries(daily).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  const monthlyAvg=Object.entries(monthly).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  return {dailyAvg,monthlyAvg};
}

function drawScoreChart(){
  const labels=state.history.map((_,i)=>`#${i+1}`);
  const scores=state.history.map(h=>h.score);
  const ctx=document.getElementById("chart").getContext("2d");
  if(scoreChart)scoreChart.destroy();
  scoreChart=new Chart(ctx,{
    type:"line",
    data:{labels,datasets:[{label:"スコア",data:scores,borderColor:"#22c55e",tension:0.2}]},
    options:{scales:{y:{beginAtZero:true,max:300}}}
  });
}

function drawAvgChart(){
  const {dailyAvg,monthlyAvg}=aggregateScoreByPeriod();
  const data=avgMode==="day"?dailyAvg:monthlyAvg;
  const ctx=document.getElementById("avgChart").getContext("2d");
  if(avgChart)avgChart.destroy();
  avgChart=new Chart(ctx,{
    type:"bar",
    data:{labels:data.map(d=>d.label),datasets:[{label:`平均スコア（${avgMode==="day"?"日":"月"}）`,data:data.map(d=>d.avg),backgroundColor:"#3b82f6"}]},
    options:{scales:{y:{beginAtZero:true,max:300}}}
  });
}
document.getElementById("dailyBtn").addEventListener("click",()=>{avgMode="day";drawAvgChart();});
document.getElementById("monthlyBtn").addEventListener("click",()=>{avgMode="month";drawAvgChart();});

// 🏅 称号
function calcStreak(){
  const days=[...new Set(state.history.map(r=>new Date(r.timestamp).toLocaleDateString()))].sort((a,b)=>new Date(b)-new Date(a));
  const today=new Date().toLocaleDateString();
  let streak=0,current=new Date(today);
  for(const d of days){
    if(new Date(d).toLocaleDateString()===current.toLocaleDateString()){
      streak++;current.setDate(current.getDate()-1);
    } else break;
  }
  return streak;
}
function calcAverageScore(){
  if(!state.history.length) return 0;
  return Math.round(state.history.reduce((a,b)=>a+b.score,0)/state.history.length);
}
function updateTitles(){
  const streak=calcStreak();
  const avg=calcAverageScore();
  const titles=[];
  if(streak>=7) titles.push("🌱 集中の芽");
  if(streak>=30) titles.push("⚔️ 継続の戦士");
  if(avg>=200) titles.push("🧠 記憶の達人");
  $("#titleDisplay").innerHTML = titles.length?titles.map(t=>`<span class="chip">${t}</span>`).join(" "):"<span class='muted'>称号なし</span>";
  $("#streakDisplay").textContent=streak;
  $("#avgDisplay").textContent=avg;
}

// 📂 ファイル読み込み
$("#file").addEventListener("change",async e=>{
  const file=e.target.files[0];
  if(!file)return;
  const text=await file.text();
  const list=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  state.pool=list;
  alert(`${list.length} 語を読み込みました`);
});

// 💾 CSV
function exportToCSV(){
  if(!state.history.length){alert("履歴なし");return;}
  const header=["No","日時","スコア","正答率","一致","見落","余分"];
  const rows=state.history.map((h,i)=>[i+1,h.timestamp,h.score,h.accuracy,h.n_hit,h.n_miss,h.n_extra]);
  const csv=[header,...rows].map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="memory_score.csv";
  a.click();URL.revokeObjectURL(url);
}
$("#exportCsv").addEventListener("click",exportToCSV);
$("#clearHist").addEventListener("click",()=>{if(confirm("履歴を消去しますか？")){state.history=[];localStorage.removeItem("hist");refreshTable();drawScoreChart();drawAvgChart();updateTitles();}});

// 🧭 イベント
$("#start").addEventListener("click",()=>{state.round=0;state.total=Number($("#rounds").value);state.seconds=Number($("#seconds").value);state.nWords=Number($("#nwords").value);nextRound();});
$("#resetAll").addEventListener("click",()=>setPhase("intro"));
$("#autoHide").addEventListener("click",startAutoHide);
$("#hideNow").addEventListener("click",hideNow);
$("#scoreBtn").addEventListener("click",scoreRound);
$("#nextRound").addEventListener("click",nextRound);

// 初期表示
refreshTable();
drawScoreChart();
drawAvgChart();
updateTitles();
</script>
</body>
</html>

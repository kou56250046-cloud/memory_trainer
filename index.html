<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ§  è¨˜æ†¶åŠ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆã‚¹ã‚³ã‚¢ï¼†ã‚°ãƒ©ãƒ•å®Œå…¨ç‰ˆï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;}
  body{background:var(--bg);color:var(--text);font-family:system-ui;margin:0}
  .wrap{max-width:960px;margin:auto;padding:16px}
  .card{background:var(--panel);padding:16px;border-radius:10px;margin-bottom:16px}
  button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
  .primary{background:var(--accent);color:#000;font-weight:bold}
  .ghost{background:#1f2937;color:var(--text)}
  .danger{background:#ef4444;color:#fff}
  .warn{background:#f59e0b;color:#000}
  .words{font-size:22px;line-height:1.8;margin-top:8px}
  .chip{background:#1f2937;padding:4px 8px;border-radius:12px;margin:2px;display:inline-block}
  .progress{background:#1f2937;height:10px;border-radius:5px;overflow:hidden;margin-top:8px}
  .bar{background:var(--accent);height:100%;width:0%}
  canvas{background:#0b1220;border:1px solid #223;border-radius:8px;width:100%;height:200px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ§  è¨˜æ†¶åŠ›ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h1>
    <div>
      <button id="start" class="primary">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ â–¶</button>
      <button id="resetAll" class="ghost">åˆæœŸåŒ–</button>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <p id="countdownNote"></p>

    <div id="phaseIntro">
      <p>å³ã®è¨­å®šã§ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ãƒ»ç§’æ•°ãƒ»å˜èªæ•°ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</p>
    </div>

    <div id="phaseShow" hidden>
      <h3>è¦šãˆã¦ãã ã•ã„</h3>
      <div class="words" id="words"></div>
      <div id="chips"></div>
      <button class="warn" id="autoHide">â³ è‡ªå‹•ã§éš ã™</button>
      <button class="ghost" id="hideNow">ğŸ™ˆ ä»Šã™ãéš ã™</button>
    </div>

    <div id="phaseAnswer" hidden>
      <h3>æ€ã„å‡ºã—ã¦å…¥åŠ›</h3>
      <textarea id="answer" rows="4" style="width:100%"></textarea>
      <button class="primary" id="scoreBtn">æ¡ç‚¹ â–¶</button>
    </div>

    <div id="phaseResult" hidden>
      <h3>çµæœ</h3>
      <p>æ­£ç­”ç‡: <span id="kpiAcc"></span>% / ã‚¹ã‚³ã‚¢: <span id="kpiScore"></span></p>
      <p>ä¸€è‡´: <span id="outHit"></span></p>
      <p>è¦‹è½ã¨ã—: <span id="outMiss"></span></p>
      <p>ä½™åˆ†: <span id="outExtra"></span></p>
      <button class="primary" id="nextRound">æ¬¡ã¸ â–¶</button>
    </div>
  </div>

  <!-- ã‚µã‚¤ãƒ‰è¨­å®š -->
  <div class="card">
    <h2>è¨­å®š</h2>
    <div>ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ï¼š<input id="rounds" type="number" value="3"></div>
    <div>è¡¨ç¤ºç§’æ•°ï¼š<input id="seconds" type="number" value="10"></div>
    <div>å˜èªæ•°ã€€ï¼š<input id="nwords" type="number" value="5"></div>
    <div>å˜èªãƒªã‚¹ãƒˆï¼š<input id="file" type="file"></div>
  </div>

  <div class="card">
    <h2>ğŸ“Š ã‚¹ã‚³ã‚¢æ¨ç§»</h2>
    <canvas id="chart"></canvas>
    <div>
      <button id="dailyBtn" class="ghost">æ—¥</button>
      <button id="monthlyBtn" class="ghost">æœˆ</button>
    </div>
    <canvas id="avgChart"></canvas>
  </div>

  <div class="card">
    <h2>ğŸ… ç§°å·</h2>
    <div id="titleDisplay"></div>
    <div>é€£ç¶šæ—¥æ•°ï¼š<span id="streakDisplay">0</span></div>
    <div>å¹³å‡ã‚¹ã‚³ã‚¢ï¼š<span id="avgDisplay">0</span></div>
  </div>

  <div class="card">
    <h2>å±¥æ­´</h2>
    <table id="histTable">
      <thead><tr><th>#</th><th>æ—¥æ™‚</th><th>ã‚¹ã‚³ã‚¢</th><th>æ­£ç­”ç‡</th><th>ä¸€è‡´</th><th>è¦‹è½</th><th>ä½™åˆ†</th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="exportCsv" class="ghost">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="clearHist" class="danger">å±¥æ­´ã‚¯ãƒªã‚¢</button>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const state = {
  pool:"å±± å· æµ· ç©º æ˜Ÿ æœˆ èŠ± é³¥ é¢¨ æ£® çŸ³ ç« æ°´ æœ¨ åœŸ å…‰ å¤¢ å¿ƒ æ„› éŸ³".split(" "),
  round:0,total:3,seconds:10,nWords:5,
  history: JSON.parse(localStorage.getItem("hist")||"[]"),
  timer:null,secLeft:0
};

function setPhase(p){
  ["Intro","Show","Answer","Result"].forEach(x=>$("#phase"+x).hidden = p!==x.toLowerCase());
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function sample(a,n){const arr=[...a];shuffle(arr);return arr.slice(0,n);}
function tokens(s){return s.replace(/[ã€,]/g," ").split(/\s+/).map(x=>x.trim()).filter(Boolean);}


function nextRound(){
  state.round++;
  if(state.round>state.total){alert("çµ‚äº†ï¼");setPhase("intro");return;}
  state.current = sample(state.pool,state.nWords);
  $("#words").textContent = state.current.join("ã€");
  $("#chips").innerHTML = state.current.map(w=>`<span class="chip">${w}</span>`).join("");
  setPhase("show");
}

function clearTimer(){if(state.timer){clearInterval(state.timer);state.timer=null}}
function hideNow(){clearTimer();setPhase("answer")}
function startAutoHide(){
  clearTimer();
  state.secLeft = state.seconds;
  const bar=$("#bar");
  bar.style.width="100%";
  state.timer = setInterval(()=>{
    state.secLeft--;
    const pct=(state.secLeft/state.seconds)*100;
    bar.style.width=pct+"%";
    $("#countdownNote").textContent=`ã‚ã¨ ${state.secLeft} ç§’`;
    if(state.secLeft<=0){clearTimer();hideNow();}
  },1000);
}

function calcScore(acc,words,sec){
  return Math.round(acc * (words/sec));
}

function scoreRound(){
  const rec=tokens($("#answer").value);
  const S=new Set(state.current),R=new Set(rec);
  const hit=[...S].filter(x=>R.has(x));
  const miss=[...S].filter(x=>!R.has(x));
  const extra=[...R].filter(x=>!S.has(x));
  const acc = state.current.length ? Math.round(hit.length/state.current.length*100) : 0;
  const score = calcScore(acc,state.current.length,state.seconds);
  $("#kpiAcc").textContent = acc;
  $("#kpiScore").textContent = score;
  $("#outHit").textContent = hit.join("ã€") || "ãªã—";
  $("#outMiss").textContent = miss.join("ã€") || "ãªã—";
  $("#outExtra").textContent = extra.join("ã€") || "ãªã—";

  const row={timestamp:new Date().toLocaleString(),score,accuracy:acc,
             n_hit:hit.length,n_miss:miss.length,n_extra:extra.length};
  state.history.push(row);
  localStorage.setItem("hist",JSON.stringify(state.history));
  refreshTable();
  drawScoreChart();
  drawAvgChart();
  updateTitles();
  setPhase("result");
}

function refreshTable(){
  const tb=$("#histTable tbody");
  tb.innerHTML="";
  state.history.forEach((h,i)=>{
    tb.innerHTML+=`<tr><td>${i+1}</td><td>${h.timestamp}</td><td>${h.score}</td>
                   <td>${h.accuracy}</td><td>${h.n_hit}</td><td>${h.n_miss}</td><td>${h.n_extra}</td></tr>`;
  });
}

// ğŸ“Š ã‚°ãƒ©ãƒ•
let scoreChart=null,avgChart=null,avgMode="day";
function aggregateScoreByPeriod(){
  const daily={},monthly={};
  for(const h of state.history){
    const d=new Date(h.timestamp);
    const day=d.toLocaleDateString();
    const month=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    (daily[day] ||= []).push(h.score);
    (monthly[month] ||= []).push(h.score);
  }
  const dailyAvg=Object.entries(daily).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  const monthlyAvg=Object.entries(monthly).map(([k,v])=>({label:k,avg:Math.round(v.reduce((a,b)=>a+b,0)/v.length)}));
  return {dailyAvg,monthlyAvg};
}

function drawScoreChart(){
  const labels=state.history.map((_,i)=>`#${i+1}`);
  const scores=state.history.map(h=>h.score);
  const ctx=document.getElementById("chart").getContext("2d");
  if(scoreChart)scoreChart.destroy();
  scoreChart=new Chart(ctx,{
    type:"line",
    data:{labels,datasets:[{label:"ã‚¹ã‚³ã‚¢",data:scores,borderColor:"#22c55e",tension:0.2}]},
    options:{scales:{y:{beginAtZero:true,max:300}}}
  });
}

function drawAvgChart(){
  const {dailyAvg,monthlyAvg}=aggregateScoreByPeriod();
  const data=avgMode==="day"?dailyAvg:monthlyAvg;
  const ctx=document.getElementById("avgChart").getContext("2d");
  if(avgChart)avgChart.destroy();
  avgChart=new Chart(ctx,{
    type:"bar",
    data:{labels:data.map(d=>d.label),datasets:[{label:`å¹³å‡ã‚¹ã‚³ã‚¢ï¼ˆ${avgMode==="day"?"æ—¥":"æœˆ"}ï¼‰`,data:data.map(d=>d.avg),backgroundColor:"#3b82f6"}]},
    options:{scales:{y:{beginAtZero:true,max:300}}}
  });
}
document.getElementById("dailyBtn").addEventListener("click",()=>{avgMode="day";drawAvgChart();});
document.getElementById("monthlyBtn").addEventListener("click",()=>{avgMode="month";drawAvgChart();});

// ğŸ… ç§°å·
function calcStreak(){
  const days=[...new Set(state.history.map(r=>new Date(r.timestamp).toLocaleDateString()))].sort((a,b)=>new Date(b)-new Date(a));
  const today=new Date().toLocaleDateString();
  let streak=0,current=new Date(today);
  for(const d of days){
    if(new Date(d).toLocaleDateString()===current.toLocaleDateString()){
      streak++;current.setDate(current.getDate()-1);
    } else break;
  }
  return streak;
}
function calcAverageScore(){
  if(!state.history.length) return 0;
  return Math.round(state.history.reduce((a,b)=>a+b.score,0)/state.history.length);
}
function updateTitles(){
  const streak=calcStreak();
  const avg=calcAverageScore();
  const titles=[];
  if(streak>=7) titles.push("ğŸŒ± é›†ä¸­ã®èŠ½");
  if(streak>=30) titles.push("âš”ï¸ ç¶™ç¶šã®æˆ¦å£«");
  if(avg>=200) titles.push("ğŸ§  è¨˜æ†¶ã®é”äºº");
  $("#titleDisplay").innerHTML = titles.length?titles.map(t=>`<span class="chip">${t}</span>`).join(" "):"<span class='muted'>ç§°å·ãªã—</span>";
  $("#streakDisplay").textContent=streak;
  $("#avgDisplay").textContent=avg;
}

// ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
$("#file").addEventListener("change",async e=>{
  const file=e.target.files[0];
  if(!file)return;
  const text=await file.text();
  const list=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  state.pool=list;
  alert(`${list.length} èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
});

// ğŸ’¾ CSV
function exportToCSV(){
  if(!state.history.length){alert("å±¥æ­´ãªã—");return;}
  const header=["No","æ—¥æ™‚","ã‚¹ã‚³ã‚¢","æ­£ç­”ç‡","ä¸€è‡´","è¦‹è½","ä½™åˆ†"];
  const rows=state.history.map((h,i)=>[i+1,h.timestamp,h.score,h.accuracy,h.n_hit,h.n_miss,h.n_extra]);
  const csv=[header,...rows].map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="memory_score.csv";
  a.click();URL.revokeObjectURL(url);
}
$("#exportCsv").addEventListener("click",exportToCSV);
$("#clearHist").addEventListener("click",()=>{if(confirm("å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")){state.history=[];localStorage.removeItem("hist");refreshTable();drawScoreChart();drawAvgChart();updateTitles();}});

// ğŸ§­ ã‚¤ãƒ™ãƒ³ãƒˆ
$("#start").addEventListener("click",()=>{state.round=0;state.total=Number($("#rounds").value);state.seconds=Number($("#seconds").value);state.nWords=Number($("#nwords").value);nextRound();});
$("#resetAll").addEventListener("click",()=>setPhase("intro"));
$("#autoHide").addEventListener("click",startAutoHide);
$("#hideNow").addEventListener("click",hideNow);
$("#scoreBtn").addEventListener("click",scoreRound);
$("#nextRound").addEventListener("click",nextRound);

// åˆæœŸè¡¨ç¤º
refreshTable();
drawScoreChart();
drawAvgChart();
updateTitles();
</script>
</body>
</html>
